# Copilot Instructions - FakeDaily Project

## Project Context

FakeDaily is a satirical news article management system with web interface for creating, editing, and publishing fake news articles with image support and WhatsApp export functionality.

---

## OWASP Top 10 Security Guidelines

When making changes to this codebase, **always** follow these security principles:

### 1. A01:2021 - Broken Access Control

‚úÖ **Current Implementation:**
- No authentication system (admin interface accessible to all)
- No role-based access control

‚ö†Ô∏è **Required Actions:**
- When adding features, do NOT introduce new access control vulnerabilities
- If authentication is added later, implement proper session management
- Never expose sensitive endpoints without protection

üîí **When coding:**
- Validate all file paths to prevent directory traversal
- Use `secure_filename()` for uploaded files
- Sanitize article IDs and parameters

### 2. A02:2021 - Cryptographic Failures

‚úÖ **Current Implementation:**
- No sensitive data stored (passwords, credit cards, etc.)
- No encryption needed for article content

‚ö†Ô∏è **Required Actions:**
- If user accounts are added: Use `werkzeug.security.generate_password_hash()`
- If API tokens are added: Store hashed, never plain text
- Use HTTPS in production (configured via reverse proxy)

### 3. A03:2021 - Injection

‚úÖ **Current Implementation:**
- Parameterized SQL queries (using `?` placeholders)
- Markdown rendering with `markdown` library (auto-escapes HTML)

‚ö†Ô∏è **Required Actions:**
- **NEVER** use f-strings or `.format()` for SQL queries
- **ALWAYS** use parameterized queries: `cursor.execute("SELECT * FROM articles WHERE id = ?", (article_id,))`
- Validate and sanitize all user inputs
- Use Jinja2 auto-escaping (enabled by default)

üîí **Example (CORRECT):**
```python
cursor.execute("UPDATE articles SET title = ? WHERE id = ?", (title, article_id))
```

‚ùå **Example (WRONG - Never do this):**
```python
cursor.execute(f"UPDATE articles SET title = '{title}' WHERE id = {article_id}")
```

### 4. A04:2021 - Insecure Design

‚úÖ **Current Implementation:**
- Image upload with file type validation
- File size limits (16MB)
- Rotating logs with size limits

‚ö†Ô∏è **Required Actions:**
- When adding features, consider abuse scenarios
- Implement rate limiting for resource-intensive operations
- Add input validation at boundaries

### 5. A05:2021 - Security Misconfiguration

‚úÖ **Current Implementation:**
- Debug mode disabled in production (`DEBUG=False`)
- Custom error pages (no stack traces exposed)
- Security logging enabled

‚ö†Ô∏è **Required Actions:**
- Never commit secrets to Git
- Use environment variables for configuration
- Keep Flask and dependencies updated
- Review `requirements.txt` regularly

üîí **Configuration checklist:**
- [ ] `DEBUG = False` in production
- [ ] `SECRET_KEY` set via environment variable
- [ ] Error handling catches exceptions
- [ ] No default credentials

### 6. A06:2021 - Vulnerable and Outdated Components

‚úÖ **Current Implementation:**
- Dependencies listed in `requirements.txt`
- Pillow for image processing
- Flask web framework

‚ö†Ô∏è **Required Actions:**
- Run `pip list --outdated` regularly
- Update dependencies with security patches
- Review CVEs for used libraries

üì¶ **Critical dependencies:**
- Flask
- Pillow (image processing - security-critical)
- markdown
- werkzeug

### 7. A07:2021 - Identification and Authentication Failures

‚úÖ **Current Implementation:**
- No authentication system (public admin interface)

‚ö†Ô∏è **If adding authentication:**
- Use `flask-login` or similar established library
- Implement password strength requirements
- Add account lockout after failed attempts
- Use secure session management
- Implement CSRF protection (`flask-wtf`)

### 8. A08:2021 - Software and Data Integrity Failures

‚úÖ **Current Implementation:**
- No CI/CD pipeline dependencies
- Direct file uploads with validation

‚ö†Ô∏è **Required Actions:**
- Validate uploaded images (file type, magic bytes)
- Check file extensions against whitelist
- Use `secure_filename()` from werkzeug

üîí **Image upload security:**
```python
from werkzeug.utils import secure_filename

ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'webp'}

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS
```

### 9. A09:2021 - Security Logging and Monitoring Failures

‚úÖ **Current Implementation:**
- Security logging to `logs/security.log`
- Application logging to `logs/app.log`
- IP anonymization (GDPR-compliant)
- User-Agent simplification
- 30-day log retention

‚ö†Ô∏è **Required Actions:**
- Log all security-relevant events (create/update/delete)
- Include anonymized IP and browser type
- Never log sensitive data (passwords, tokens)
- Use `log_security_event()` helper function

üîí **Logging guidelines:**
```python
# ‚úÖ CORRECT - GDPR-compliant
log_security_event(
    f"Article created: ID={article_id}, Title='{title}'",
    user_agent=request.headers.get('User-Agent', 'unknown')
)

# ‚ùå WRONG - Logs full IP and UA
logging.info(f"User {request.remote_addr} created article - {request.headers.get('User-Agent')}")
```

**What to log:**
- ‚úÖ Article create/update/delete
- ‚úÖ Image upload/delete
- ‚úÖ Errors and exceptions
- ‚ùå Normal page views (read-only)
- ‚ùå Search queries
- ‚ùå Sensitive data

### 10. A10:2021 - Server-Side Request Forgery (SSRF)

‚úÖ **Current Implementation:**
- No URL fetching functionality
- Image uploads from local files only

‚ö†Ô∏è **If adding URL-based features:**
- Validate and sanitize URLs
- Use allowlist for domains
- Disable redirects
- Don't expose internal network access

---

## GDPR/DSGVO Compliance Guidelines

When making changes to this codebase, **always** ensure GDPR compliance:

### 1. Data Minimization (Art. 5 Abs. 1 lit. c DSGVO)

‚úÖ **Current Implementation:**
- IP addresses anonymized (last octet set to 0)
- User-Agent simplified to browser type only
- No cookies for tracking
- No personal data collection

‚ö†Ô∏è **Required Actions:**
- Only collect data that is absolutely necessary
- Never add analytics without anonymization
- Avoid storing identifiable information

üîí **Anonymization functions:**
```python
def anonymize_ip(ip_address):
    """Anonymizes IP address (GDPR-compliant)"""
    # 192.168.1.123 ‚Üí 192.168.1.0
    
def simplify_user_agent(user_agent):
    """Reduces User-Agent to browser type only"""
    # Mozilla/5.0... Chrome/120.0 ‚Üí "Chrome"
```

**When adding logging:**
- ‚úÖ Use `anonymize_ip()` for IP addresses
- ‚úÖ Use `simplify_user_agent()` for User-Agent
- ‚ùå Never log full IP addresses
- ‚ùå Never log detailed User-Agent strings

### 2. Storage Limitation (Art. 5 Abs. 1 lit. e DSGVO)

‚úÖ **Current Implementation:**
- Logs auto-deleted after 30 days
- TimedRotatingFileHandler with `backupCount=30`
- Daily rotation at midnight

‚ö†Ô∏è **Required Actions:**
- Never change log retention beyond 30 days without legal basis
- Implement automatic deletion for any new data types
- Document retention periods

üîí **Log rotation configuration:**
```python
from logging.handlers import TimedRotatingFileHandler

handler = TimedRotatingFileHandler(
    LOG_DIR / 'security.log',
    when='midnight',      # Daily rotation
    interval=1,
    backupCount=30,       # Keep 30 days
    encoding='utf-8'
)
```

### 3. Purpose Limitation (Art. 5 Abs. 1 lit. b DSGVO)

‚úÖ **Current Implementation:**
- Logs only for security and debugging
- No tracking, analytics, or profiling
- Clear purpose: IT security and incident response

‚ö†Ô∏è **Required Actions:**
- Document purpose for any new data collection
- Don't repurpose data for other uses
- Keep purposes specific and limited

**Allowed logging purposes:**
- ‚úÖ Security monitoring
- ‚úÖ Incident response
- ‚úÖ Debugging errors
- ‚ùå User profiling
- ‚ùå Marketing
- ‚ùå Analytics

### 4. Legal Basis (Art. 6 DSGVO)

‚úÖ **Current Legal Basis:**
- Art. 6 Abs. 1 lit. f DSGVO - Legitimate Interest
- Purpose: Protection of IT security and system integrity
- Interest balancing: Minimal data collection (anonymized) vs. security needs

‚ö†Ô∏è **When adding features:**
- Document legal basis for new data processing
- Consider if consent is required (usually not for security logs)
- Update `DSGVO_Report.md` with new processing activities

### 5. Data Subject Rights (Art. 15-22 DSGVO)

‚úÖ **Current Implementation:**
- No identifiable personal data (anonymized)
- Rights automatically fulfilled through:
  - Automatic deletion after 30 days (Art. 17)
  - No need for correction (no personal data stored)
  
‚ö†Ô∏è **If adding user accounts:**
- Implement data export (Art. 20)
- Implement deletion on request (Art. 17)
- Implement right to information (Art. 15)

### 6. Privacy by Design/Default (Art. 25 DSGVO)

‚úÖ **Current Implementation:**
- Anonymization enabled by default
- No opt-out needed (no tracking)
- Minimal data collection from start

‚ö†Ô∏è **When adding features:**
- Privacy-friendly defaults (opt-in, not opt-out)
- Anonymization/pseudonymization from start
- Data minimization built into design

üîí **Design principles:**
1. Collect only what's needed
2. Anonymize immediately
3. Delete automatically
4. No tracking by default
5. Transparent processing

### 7. LocalStorage and Browser Data

‚úÖ **Current Implementation:**
- Only stores font size preference (`fontSize`)
- No personal data in LocalStorage
- User can delete anytime

‚ö†Ô∏è **When adding LocalStorage:**
- Only store preferences, never identifiable data
- Document in privacy policy
- Make it clear it's stored locally

### 8. Documentation Requirements

‚ö†Ô∏è **When adding features, update:**
- [ ] `DSGVO_Report.md` - Processing activities
- [ ] Privacy policy (if published)
- [ ] Processing registry (Art. 30)
- [ ] Code comments for GDPR relevance

---

## Development Standards

### Python Environment

**Virtual Environment:**
- ‚úÖ **ALWAYS use `.venv`** for Python projects
- Create with: `python3 -m venv .venv`
- Activate: `source .venv/bin/activate` (Linux/Mac) or `.venv\Scripts\activate` (Windows)
- Never commit `.venv/` to Git (already in `.gitignore`)

**Dependencies:**
- Keep `requirements.txt` up to date
- Pin versions for production: `pip freeze > requirements.txt`
- Document any system dependencies in README

### Testing Requirements

**Test-Driven Development:**
- ‚úÖ **Create a unit test for EVERY implemented feature** (pytest)
- Write tests in `tests/` directory
- Test file naming: `test_<feature>.py`
- Use descriptive test names: `test_<what>_<condition>_<expected_result>`

**Test Structure:**
```python
# tests/test_myfeature.py
import pytest
from mymodule import myfunction

class TestMyFeature:
    """Tests for MyFeature functionality"""
    
    @pytest.fixture(autouse=True)
    def setup_and_cleanup(self):
        """Setup before and cleanup after each test"""
        # Setup
        yield
        # Cleanup
    
    def test_myfunction_with_valid_input_returns_expected(self):
        """Test: myfunction with valid input returns expected result"""
        result = myfunction("valid")
        assert result == "expected"
    
    def test_myfunction_with_invalid_input_raises_error(self):
        """Test: myfunction with invalid input raises ValueError"""
        with pytest.raises(ValueError):
            myfunction("invalid")
```

**When to Write Tests:**
- ‚úÖ New API endpoints ‚Üí Test all HTTP methods and status codes
- ‚úÖ New database operations ‚Üí Test CRUD operations
- ‚úÖ New utility functions ‚Üí Test edge cases and error handling
- ‚úÖ Bug fixes ‚Üí Write test that reproduces bug first
- ‚úÖ Refactoring ‚Üí Ensure tests still pass

**Test Coverage:**
- Run tests before committing: `pytest -v`
- Ensure tests clean up after themselves (no DB pollution)
- Use fixtures for setup/teardown
- Mock external dependencies when appropriate

**Example Test Patterns:**

```python
# API Endpoint Test
def test_api_upload_images_success(self):
    """Test: Upload images via API returns success"""
    with open('test_image.png', 'rb') as f:
        response = requests.post(
            f"{API_BASE}/upload/images/1",
            files={'images': f}
        )
    assert response.status_code == 200
    assert response.json()['success'] is True

# Database Test with Cleanup
@pytest.fixture
def test_article(self):
    """Create test article, yield ID, delete after test"""
    article_id = db.add_article("Test", "Content")
    yield article_id
    db.delete_article(article_id)

def test_get_article_returns_correct_data(self, test_article):
    """Test: get_article returns correct article data"""
    article = db.get_article(test_article)
    assert article['title'] == "Test"
    assert article['content'] == "Content"
```

## Code Style and Best Practices

### Python Style
- Follow PEP 8
- Use type hints where helpful
- Write descriptive docstrings
- Keep functions focused and small

### SQL Queries
```python
# ‚úÖ GOOD - Parameterized
cursor.execute("SELECT * FROM articles WHERE id = ?", (article_id,))

# ‚úÖ GOOD - Multiple parameters
cursor.execute(
    "UPDATE articles SET title = ?, content = ? WHERE id = ?",
    (title, content, article_id)
)

# ‚ùå BAD - SQL Injection risk
cursor.execute(f"SELECT * FROM articles WHERE id = {article_id}")
```

### Error Handling
```python
# ‚úÖ GOOD - Catch specific exceptions
try:
    article = db.get_article(article_id)
except sqlite3.Error as e:
    app_logger.error(f"Database error: {e}")
    flash('Datenbankfehler', 'error')
```

### Image Processing
```python
# ‚úÖ GOOD - Validate before processing
from werkzeug.utils import secure_filename

filename = secure_filename(file.filename)
if allowed_file(filename):
    # Process image
```

---

## Testing Checklist

Before committing changes:

**Security:**
- [ ] No SQL injection vulnerabilities (parameterized queries)
- [ ] Input validation on all user inputs
- [ ] File uploads validated (type, size, name)
- [ ] No sensitive data in logs
- [ ] Error messages don't expose internal details

**GDPR:**
- [ ] IP addresses anonymized in logs
- [ ] User-Agent simplified in logs
- [ ] No personal data collected without legal basis
- [ ] Automatic deletion configured (if applicable)
- [ ] Documentation updated

**Functionality:**
- [ ] Feature works as expected
- [ ] Edge cases handled
- [ ] Error messages are user-friendly (German)
- [ ] Responsive design (mobile + desktop)

**Testing:**
- [ ] Unit test created for new feature
- [ ] Test runs successfully (`pytest -v`)
- [ ] Test includes cleanup (no DB pollution)
- [ ] Edge cases covered in tests

---

## Common Pitfalls to Avoid

‚ùå **Never do this:**
```python
# SQL Injection
query = f"SELECT * FROM articles WHERE title = '{title}'"

# Logging sensitive data
logging.info(f"User password: {password}")

# Full IP logging
logging.info(f"IP: {request.remote_addr}")

# Unvalidated file paths
filepath = os.path.join(UPLOAD_DIR, request.form.get('filename'))
```

‚úÖ **Always do this:**
```python
# Parameterized queries
cursor.execute("SELECT * FROM articles WHERE title = ?", (title,))

# Never log sensitive data
# (Don't log passwords at all)

# Anonymized IP
anonymized_ip = anonymize_ip(request.remote_addr)

# Validated filenames
filename = secure_filename(uploaded_file.filename)
```

---

## Production Deployment (Stage Server)

### Server Zugriff

**SSH Connection:**
```bash
ssh uu@stage
cd FakeDaily
```

**Container Information:**
- **Service Name:** `cms-app`
- **Container Name:** `cms`
- **URL:** http://stage:5001/cms
- **API URL:** http://stage:5001/cms/admin/api

### Container-Operationen

**Status pr√ºfen:**
```bash
ssh uu@stage 'cd FakeDaily && docker compose ps'
```

**Logs anzeigen:**
```bash
ssh uu@stage 'cd FakeDaily && docker compose logs -f cms-app'
```

**In Container ausf√ºhren:**
```bash
# Interaktiv
ssh -t uu@stage 'cd FakeDaily && docker compose exec cms-app bash'

# Script ausf√ºhren
ssh uu@stage 'cd FakeDaily && docker compose exec -T cms-app bash' < local_script.sh

# Python-Code direkt
ssh uu@stage 'cd FakeDaily && docker compose exec -T cms-app python3 -c "import sys; print(sys.version)"'
```

**Beispiel: Re-Tagging auf Production:**
```bash
ssh uu@stage 'cd FakeDaily && docker compose exec -T cms-app bash' < scripts/retag_in_container.sh
```

### Datenbank-Zugriff

**Datenbank-Pfad im Container:**
```
/app/database/articles.db
```

**SQLite CLI:**
```bash
ssh uu@stage 'cd FakeDaily && docker compose exec cms-app sqlite3 /app/database/articles.db'
```

**Python DB-Zugriff:**
```python
import sqlite3
conn = sqlite3.connect('/app/database/articles.db')
cursor = conn.cursor()
# ... queries ...
conn.close()
```

### Wichtige Pfade im Container

- Arbeitsverzeichnis: `/app`
- Source Code: `/app/web/app.py`, `/app/src/`
- Datenbank: `/app/database/articles.db`
- Media/Bilder: `/app/media/images/`
- Logs: `/app/logs/`

### Deployment-Prozess

1. **Code-Update:**
   ```bash
   ssh uu@stage 'cd FakeDaily && git pull'
   ```

2. **Container neu starten:**
   ```bash
   ssh uu@stage 'cd FakeDaily && docker compose restart cms-app'
   ```

3. **Oder vollst√§ndig neu bauen:**
   ```bash
   ssh uu@stage 'cd FakeDaily && docker compose up -d --build'
   ```

---

## References

- **OWASP Top 10 2021:** https://owasp.org/Top10/
- **GDPR Full Text:** https://gdpr-info.eu/
- **Flask Security:** https://flask.palletsprojects.com/en/latest/security/
- **Project Reports:** 
  - `OWASP10_Report.md` - Security assessment
  - `DSGVO_Report.md` - GDPR compliance documentation

---

## Questions?

If unsure about security or privacy implications:
1. Check existing code patterns
2. Review OWASP10_Report.md and DSGVO_Report.md
3. Apply principle of least privilege
4. When in doubt, minimize data collection

**Remember:** Security and privacy are not features to add later - they must be built in from the start.
