{% extends "base.html" %}

{% block title %}Artikel - {{ SITE_TITLE }}{% endblock %}

{% block content %}
<div class="header-section">
    <h1>Artikel-Verwaltung</h1>
    
    <form method="GET" action="{{ url_for('index') }}" class="search-form">
        <input type="text" name="q" placeholder="Artikel durchsuchen..." value="{{ search_query }}" class="search-input">
        <button type="submit" class="btn btn-secondary">üîç Suchen</button>
    </form>
    
    <div class="filter-buttons">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Alle</a>
        <a href="{{ url_for('index', published='yes') }}" class="btn btn-secondary">Nur Ver√∂ffentlichte</a>
    </div>
    
    <div class="view-toggle">
        <button class="btn btn-sm" id="gridBtn" onclick="setView('grid')">üìä Grid</button>
        <button class="btn btn-sm" id="listBtn" onclick="setView('list')">üìã Liste</button>
        <button class="btn btn-sm" id="cardsBtn" onclick="setView('cards')">üóÇÔ∏è Karten</button>
    </div>
</div>

{% if articles %}
{% set view_mode = request.args.get('view', '') %}
{% set sort_by = sort_by|default('id') %}
{% set sort_order = sort_order|default('desc') %}

{% if view_mode == 'list' or view_mode == 'cards' %}
<!-- Listenansicht / Kartenansicht -->
<div class="articles-list {% if view_mode == 'cards' %}view-cards{% endif %}">
    <table class="articles-table">
        <thead>
            <tr>
                <th style="width: 50px;">
                    <a href="{{ url_for('index', view='list', sort='id', order='asc' if sort_by == 'id' and sort_order == 'desc' else 'desc', q=search_query, published=request.args.get('published')) }}" class="sort-header">
                        ID {% if sort_by == 'id' %}{{ '‚ñ≤' if sort_order == 'asc' else '‚ñº' }}{% endif %}
                    </a>
                </th>
                <th style="width: 80px;">
                    <a href="{{ url_for('index', view='list', sort='status', order='asc' if sort_by == 'status' and sort_order == 'desc' else 'desc', q=search_query, published=request.args.get('published')) }}" class="sort-header">
                        Status {% if sort_by == 'status' %}{{ '‚ñ≤' if sort_order == 'asc' else '‚ñº' }}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="{{ url_for('index', view='list', sort='title', order='asc' if sort_by == 'title' and sort_order == 'desc' else 'desc', q=search_query, published=request.args.get('published')) }}" class="sort-header">
                        Titel {% if sort_by == 'title' %}{{ '‚ñ≤' if sort_order == 'asc' else '‚ñº' }}{% endif %}
                    </a>
                </th>
                <th style="width: 200px;">
                    <a href="{{ url_for('index', view='list', sort='tags', order='asc' if sort_by == 'tags' and sort_order == 'desc' else 'desc', q=search_query, published=request.args.get('published')) }}" class="sort-header">
                        Tags {% if sort_by == 'tags' %}{{ '‚ñ≤' if sort_order == 'asc' else '‚ñº' }}{% endif %}
                    </a>
                </th>
                <th style="width: 150px;">
                    <a href="{{ url_for('index', view='list', sort='date', order='asc' if sort_by == 'date' and sort_order == 'desc' else 'desc', q=search_query, published=request.args.get('published')) }}" class="sort-header">
                        Datum {% if sort_by == 'date' %}{{ '‚ñ≤' if sort_order == 'asc' else '‚ñº' }}{% endif %}
                    </a>
                </th>
                <th style="width: 200px;">Aktionen</th>
            </tr>
        </thead>
        <tbody>
        {% for article in articles %}
            <tr class="article-row {% if not article.published %}unpublished{% endif %}">
                <td class="article-id" data-label="ID">{{ article.id }}</td>
                <td data-label="Status">
                    {% if article.published %}
                        <span class="badge badge-success">‚úì Ver√∂ffentlicht</span>
                    {% else %}
                        <span class="badge badge-draft">‚óã Entwurf</span>
                    {% endif %}
                </td>
                <td class="article-title" data-label="Titel">
                    <a href="{{ url_for('view_article', article_id=article.id) }}">{{ article.title }}</a>
                </td>
                <td class="article-tags-cell" data-label="Tags">
                    {% if article.tags %}
                        {% for tag in article.tags[:3] %}
                            <span class="tag tag-sm">{{ tag }}</span>
                        {% endfor %}
                        {% if article.tags|length > 3 %}
                            <span class="tag tag-sm">+{{ article.tags|length - 3 }}</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td class="article-date" data-label="Datum">{{ article.created_at|datetime }}</td>
                <td class="article-actions-cell" data-label="Aktionen">
                    <a href="{{ url_for('view_article', article_id=article.id) }}" class="btn btn-sm" title="Ansehen">üëÅÔ∏è Ansehen</a>
                    <a href="{{ url_for('edit_article', article_id=article.id) }}" class="btn btn-sm btn-secondary" title="Bearbeiten">‚úèÔ∏è Bearbeiten</a>
                    <a href="{{ url_for('whatsapp_export', article_id=article.id) }}" class="btn btn-sm btn-secondary" title="WhatsApp Export">üì± WhatsApp</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<!-- Grid-Ansicht -->
<div class="articles-grid">
    {% for article in articles %}
    <div class="article-card" style="cursor: pointer; position: relative;" title="Weiterlesen" onclick="window.location='{{ url_for('view_article', article_id=article.id) }}'">
        <div class="article-header">
            <h2>
                <a href="{{ url_for('view_article', article_id=article.id) }}" onclick="event.stopPropagation()">{{ article.title }}</a>
            </h2>
            {% if article.published %}
                <span class="badge badge-success">Ver√∂ffentlicht</span>
            {% else %}
                <span class="badge badge-draft">Entwurf</span>
            {% endif %}
        </div>
        
        <div class="article-meta">
            {% if article.author %}
                <span>üë§ {{ article.author }}</span>
            {% endif %}
            <span>üìÖ {{ article.created_at|datetime }}</span>
        </div>
        
        {% if article.tags %}
        <div class="article-tags">
            {% for tag in article.tags %}
                <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="article-preview markdown-content">
            {{ article.excerpt_html|safe }}{% if article.content|length > 200 %}<a href="{{ url_for('view_article', article_id=article.id) }}" onclick="event.stopPropagation()">...</a>{% endif %}
        </div>
        
        <div class="article-actions">
            <a href="{{ url_for('view_article', article_id=article.id) }}" class="btn btn-sm" onclick="event.stopPropagation()">Ansehen</a>
            <a href="{{ url_for('edit_article', article_id=article.id) }}" class="btn btn-sm btn-secondary" onclick="event.stopPropagation()">Bearbeiten</a>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% else %}
<div class="empty-state">
    <p>Keine Artikel gefunden.</p>
    <a href="{{ url_for('new_article') }}" class="btn btn-primary">Ersten Artikel erstellen</a>
</div>
{% endif %}

<script>
// Fr√ºhe Pr√ºfung: Stelle sicher, dass URL mit localStorage √ºbereinstimmt
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const urlView = urlParams.get('view');
    const urlSort = urlParams.get('sort');
    const urlOrder = urlParams.get('order');
    
    const savedView = localStorage.getItem('adminViewMode') || 'grid';
    const savedSort = localStorage.getItem('adminSortBy') || 'id';
    const savedOrder = localStorage.getItem('adminSortOrder') || 'desc';
    
    let needsRedirect = false;
    const url = new URL(window.location);
    
    // Wenn Listenansicht gespeichert ist, aber kein view-Parameter vorhanden
    if (!urlView && savedView === 'list') {
        url.searchParams.set('view', 'list');
        needsRedirect = true;
    }
    
    // Wenn in Listenansicht, aber Sortierparameter fehlen
    if ((urlView === 'list' || savedView === 'list') && (!urlSort || !urlOrder)) {
        if (!urlSort) url.searchParams.set('sort', savedSort);
        if (!urlOrder) url.searchParams.set('order', savedOrder);
        needsRedirect = true;
    }
    
    if (needsRedirect) {
        // Erhalte andere Parameter (q, published, etc.)
        const currentQ = urlParams.get('q');
        const currentPublished = urlParams.get('published');
        if (currentQ) url.searchParams.set('q', currentQ);
        if (currentPublished) url.searchParams.set('published', currentPublished);
        
        window.location.href = url.toString();
    }
})();

// Lade gespeicherte View-Einstellung aus localStorage oder nutze URL-Parameter
function getViewMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const urlView = urlParams.get('view');
    
    // URL-Parameter hat Vorrang vor localStorage
    if (urlView) {
        localStorage.setItem('adminViewMode', urlView);
        return urlView;
    }
    
    // Fallback auf localStorage oder 'grid' als Default
    return localStorage.getItem('adminViewMode') || 'grid';
}

// Lade gespeicherte Sortiereinstellungen
function getSortSettings() {
    const urlParams = new URLSearchParams(window.location.search);
    const urlSort = urlParams.get('sort');
    const urlOrder = urlParams.get('order');
    
    // URL-Parameter haben Vorrang
    if (urlSort || urlOrder) {
        const settings = {
            sortBy: urlSort || localStorage.getItem('adminSortBy') || 'id',
            sortOrder: urlOrder || localStorage.getItem('adminSortOrder') || 'desc'
        };
        localStorage.setItem('adminSortBy', settings.sortBy);
        localStorage.setItem('adminSortOrder', settings.sortOrder);
        return settings;
    }
    
    // Fallback auf localStorage
    return {
        sortBy: localStorage.getItem('adminSortBy') || 'id',
        sortOrder: localStorage.getItem('adminSortOrder') || 'desc'
    };
}

// Setze View-Mode und speichere in localStorage
function setView(mode) {
    localStorage.setItem('adminViewMode', mode);
    const url = new URL(window.location);
    if (mode === 'list' || mode === 'cards') {
        url.searchParams.set('view', mode);
        // Sortiereinstellungen auch √ºbernehmen
        const sortSettings = getSortSettings();
        url.searchParams.set('sort', sortSettings.sortBy);
        url.searchParams.set('order', sortSettings.sortOrder);
    } else {
        url.searchParams.delete('view');
    }
    window.location.href = url.toString();
}

// Initialisiere View beim Laden der Seite
document.addEventListener('DOMContentLoaded', function() {
    const viewMode = getViewMode();
    const gridBtn = document.getElementById('gridBtn');
    const listBtn = document.getElementById('listBtn');
    const cardsBtn = document.getElementById('cardsBtn');
    
    // Aktualisiere Button-Status
    gridBtn.classList.remove('btn-primary');
    listBtn.classList.remove('btn-primary');
    cardsBtn.classList.remove('btn-primary');
    
    if (viewMode === 'list') {
        listBtn.classList.add('btn-primary');
    } else if (viewMode === 'cards') {
        cardsBtn.classList.add('btn-primary');
    } else {
        gridBtn.classList.add('btn-primary');
    }
});
</script>
{% endblock %}
