{% extends "base.html" %}

{% block title %}WhatsApp Export - {{ article.title }}{% endblock %}

{% block content %}
<div class="whatsapp-export">
    <div class="export-header">
        <h1>üì± WhatsApp Export</h1>
        <p class="subtitle">{{ article.title }}</p>
    </div>
    
    <div class="export-section">
        <div class="section-header">
            <h2>üìù Text</h2>
            <button class="btn btn-primary" onclick="copyText()">üìã Text kopieren</button>
        </div>
        <div class="whatsapp-preview">
            <pre id="whatsapp-text">{{ whatsapp_text }}</pre>
        </div>
        <small class="help-text">
            WhatsApp-Formatierung: *fett*, _kursiv_, ~durchgestrichen~, ```code```
        </small>
    </div>
    
    {% if images %}
    <div class="export-section">
        <div class="section-header">
            <h2>üñºÔ∏è Bilder (mit Logo)</h2>
            <p class="help-text">Rechtsklick ‚Üí "Bild speichern" oder direkt in WhatsApp einf√ºgen</p>
        </div>
        <div class="export-images">
            {% for image in images %}
            <div class="export-image-item">
                <img src="{{ url_for('serve_image', filename=image.filename) }}" 
                     alt="{{ image.alt_text or article.title }}"
                     id="image-{{ loop.index }}">
                <div class="image-actions">
                    <a href="{{ url_for('serve_image', filename=image.filename) }}" 
                       download="{{ image.filename }}" 
                       class="btn btn-sm btn-secondary">üíæ Download</a>
                    <button class="btn btn-sm btn-primary" onclick="copyImage('image-{{ loop.index }}')">
                        üìã Bild kopieren
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="export-instructions">
        <h3>üì≤ So postest du in WhatsApp:</h3>
        <ol>
            <li><strong>Text kopieren:</strong> Klicke auf "Text kopieren" und f√ºge ihn in WhatsApp ein</li>
            <li><strong>Bilder einf√ºgen:</strong> 
                <ul>
                    <li><strong>Desktop:</strong> Klicke "Bild kopieren" und f√ºge es direkt in WhatsApp ein (Strg+V)</li>
                    <li><strong>Mobil:</strong> Lade Bilder herunter und teile sie aus der Galerie</li>
                </ul>
            </li>
            <li><strong>Reihenfolge:</strong> Erst Bilder, dann Text (oder andersherum je nach Wunsch)</li>
        </ol>
    </div>
    
    <div class="export-actions">
        <a href="{{ url_for('view_article', article_id=article.id) }}" class="btn btn-secondary">‚Üê Zur√ºck zum Artikel</a>
    </div>
</div>

<script>
function copyText() {
    const textElement = document.getElementById('whatsapp-text');
    const text = textElement.textContent;
    const btn = event.target;
    
    // Methode 1: Moderne Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
            showSuccess(btn);
        }).catch(function(err) {
            console.error('Clipboard API failed:', err);
            // Fallback zu Methode 2
            copyTextFallback(text, btn);
        });
    } else {
        // Fallback zu Methode 2
        copyTextFallback(text, btn);
    }
}

function copyTextFallback(text, btn) {
    // Methode 2: Klassische Selektion + execCommand
    try {
        const textElement = document.getElementById('whatsapp-text');
        
        // Tempor√§res Textarea-Element f√ºr mobile Ger√§te
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.top = '0';
        textarea.style.left = '0';
        textarea.style.width = '2em';
        textarea.style.height = '2em';
        textarea.style.padding = '0';
        textarea.style.border = 'none';
        textarea.style.outline = 'none';
        textarea.style.boxShadow = 'none';
        textarea.style.background = 'transparent';
        document.body.appendChild(textarea);
        
        // F√ºr iOS
        textarea.contentEditable = true;
        textarea.readOnly = false;
        
        // Text selektieren
        if (navigator.userAgent.match(/ipad|iphone/i)) {
            const range = document.createRange();
            range.selectNodeContents(textarea);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            textarea.setSelectionRange(0, 999999);
        } else {
            textarea.select();
        }
        
        // Kopieren
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
            showSuccess(btn);
        } else {
            throw new Error('execCommand failed');
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert('Kopieren fehlgeschlagen. Bitte markiere den Text manuell und kopiere ihn mit der Zwischenablage deines Ger√§ts.');
    }
}

async function copyImage(imageId) {
    const img = document.getElementById(imageId);
    const btn = event.target;
    
    // Pr√ºfe ob Clipboard API f√ºr Bilder unterst√ºtzt wird
    if (!navigator.clipboard || !navigator.clipboard.write) {
        showImageCopyNotSupported();
        return;
    }
    
    try {
        // Bild als Blob laden
        const response = await fetch(img.src);
        const blob = await response.blob();
        
        // Pr√ºfe ob der Blob-Typ unterst√ºtzt wird
        if (!blob.type.startsWith('image/')) {
            throw new Error('Invalid image type');
        }
        
        // In Zwischenablage kopieren
        await navigator.clipboard.write([
            new ClipboardItem({
                [blob.type]: blob
            })
        ]);
        
        showSuccess(btn);
    } catch (err) {
        console.error('Image copy failed:', err);
        showImageCopyNotSupported();
    }
}

function showSuccess(btn) {
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚úì Kopiert!';
    btn.classList.add('btn-success');
    setTimeout(function() {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
    }, 2000);
}

function showImageCopyNotSupported() {
    if (confirm('Automatisches Kopieren wird auf diesem Ger√§t nicht unterst√ºtzt.\n\nM√∂chtest du das Bild stattdessen herunterladen?')) {
        // Der Download-Button wird durch den bestehenden Download-Link gehandhabt
        // Wir geben nur eine Meldung aus
        alert('Bitte nutze den "Download" Button und teile das Bild dann aus deiner Galerie.');
    }
}
</script>

<style>
.whatsapp-export {
    max-width: 800px;
    margin: 0 auto;
}

.export-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border);
}

.export-header h1 {
    margin-bottom: 0.5rem;
}

.subtitle {
    font-size: 1.25rem;
    color: var(--secondary);
}

.export-section {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-header h2 {
    margin: 0;
}

.whatsapp-preview {
    background: #e5ddd5;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.whatsapp-preview pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: inherit;
    font-size: 0.95rem;
    line-height: 1.5;
    color: #000;
}

.export-images {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.export-image-item {
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    overflow: hidden;
}

.export-image-item img {
    width: 100%;
    height: auto;
    display: block;
}

.image-actions {
    padding: 0.75rem;
    display: flex;
    gap: 0.5rem;
    background: var(--light);
}

.export-instructions {
    background: #fff3cd;
    padding: 1.5rem;
    border-radius: 0.5rem;
    border: 1px solid #ffc107;
    margin-bottom: 1.5rem;
}

.export-instructions h3 {
    margin-top: 0;
    color: #856404;
}

.export-instructions ol,
.export-instructions ul {
    margin-left: 1.5rem;
}

.export-instructions li {
    margin-bottom: 0.5rem;
}

.export-actions {
    text-align: center;
    padding-top: 1rem;
}
</style>
{% endblock %}
